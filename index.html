<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Directo Messenger</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #248bf5; --bg: #0f0f0f; --card: #1c1c1e; --border: #2c2c2e; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* Авторизация */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--card); padding: 40px; border-radius: 24px; width: 100%; max-width: 360px; text-align: center; border: 1px solid var(--border); }
        .auth-card h1 { font-size: 32px; font-weight: 700; margin: 0 0 10px; background: linear-gradient(45deg, #248bf5, #00ffa3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Основная сетка (Telegram Style) */
        .sidebar { width: 320px; background: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #000; }

        /* Моб. адаптация */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* Позже можно сделать переключатель */
        }

        /* Список чатов */
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .chat-item { padding: 15px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #ffffff05; }
        .chat-item:hover { background: #ffffff0a; }

        /* Окно чата */
        .chat-header { padding: 12px 20px; background: rgba(28,28,30,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }

        /* Облачка сообщений */
        .msg-row { display: flex; gap: 8px; max-width: 80%; margin-bottom: 4px; }
        .msg-row.me { align-self: flex-end; flex-direction: row-reverse; }
        .ava-msg { width: 30px; height: 30px; border-radius: 10px; object-fit: cover; align-self: flex-end; }
        
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; }
        .me .bubble { background: var(--primary); border-bottom-right-radius: 4px; }
        .not-me .bubble { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .msg-img { width: 100%; max-width: 280px; border-radius: 12px; margin-top: 5px; }

        /* Ввод (Скрепка тут!) */
        .input-wrap { padding: 15px 20px; background: var(--card); display: flex; align-items: center; gap: 12px; }
        .input-box { flex: 1; background: #09090b; border: 1px solid var(--border); border-radius: 20px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        .input-box input { flex: 1; background: none; border: none; color: white; outline: none; font-size: 15px; }
        
        .btn-icon { color: #a1a1aa; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .btn-icon:hover { color: var(--primary); }
        .btn-send { background: var(--primary); color: white; width: 38px; height: 38px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Инпуты авторизации */
        .field { width: 100%; background: #09090b; border: 1px solid var(--border); padding: 14px; border-radius: 14px; color: white; margin-bottom: 10px; }
        .btn-blue { width: 100%; background: var(--primary); color: white; padding: 14px; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; }

        /* Профиль Модалка */
        #prof-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .prof-card { background: var(--card); padding: 30px; border-radius: 30px; width: 320px; text-align: center; border: 1px solid var(--border); }
        .profile-pic { width: 100px; height: 100px; border-radius: 35px; object-fit: cover; margin-bottom: 15px; border: 3px solid var(--primary); cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h1>Directo</h1>
            <p style="color: #8e8e93; margin-bottom: 30px;">Твой новый мессенджер</p>
            <input type="email" id="email" class="field" placeholder="Email">
            <input type="password" id="pass" class="field" placeholder="Пароль">
            <div id="reg-fields" style="display:none">
                <input type="text" id="nick" class="field" placeholder="Как вас зовут?">
            </div>
            <button class="btn-blue" id="authBtn">Войти</button>
            <p id="toggleAuth" style="color: var(--primary); font-size: 14px; margin-top: 20px; cursor: pointer;">Создать аккаунт</p>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 20px; margin: 0;">Directo</h2>
            <div id="openProf" style="cursor:pointer"><i data-lucide="settings" size="20"></i></div>
        </div>
        <div class="chat-item">
            <div style="width:48px; height:48px; background: var(--primary); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="users"></i>
            </div>
            <div>
                <div style="font-weight: 600;">Общий чат</div>
                <div style="font-size: 13px; color: #8e8e93;">Directo Community</div>
            </div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div style="width:35px; height:35px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="users" size="18"></i>
            </div>
            <div style="font-weight: 600;">Общий чат</div>
        </div>

        <div id="messages"></div>

        <div class="input-wrap">
            <div class="input-box">
                <label class="btn-icon">
                    <i data-lucide="paperclip" size="20"></i>
                    <input type="file" id="fileInp" hidden accept="image/*">
                </label>
                <input type="text" id="msgInp" placeholder="Сообщение...">
            </div>
            <button class="btn-send" id="sendBtn">
                <i data-lucide="arrow-up" size="20"></i>
            </button>
        </div>
    </div>

    <div id="prof-modal">
        <div class="prof-card">
            <label>
                <img id="pPic" src="" class="profile-pic">
                <input type="file" id="avaInp" hidden accept="image/*">
            </label>
            <h3 id="pNick" style="margin: 0 0 5px;">...</h3>
            <p id="pEmail" style="font-size: 13px; color: #8e8e93; margin-bottom: 25px;">...</p>
            <button class="btn-blue" onclick="location.reload()">Обновить</button>
            <button class="btn-blue" style="background:#ff3b30; margin-top:10px;" id="logoutBtn">Выйти</button>
            <p style="margin-top: 15px; font-size: 12px; color: #8e8e93; cursor:pointer;" onclick="closeProf()">Закрыть</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdOZrTcE4ATDlGldnW8_dWRmHuaUuJfak",
            authDomain: "mysuperchat-d1c29.firebaseapp.com",
            projectId: "mysuperchat-d1c29",
            storageBucket: "mysuperchat-d1c29.firebasestorage.app",
            messagingSenderId: "299888628640",
            appId: "1:299888628640:web:caf0535b94e389c7948ac5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const IMGBB_KEY = "699042c759021469e38f5370217a808f";

        let isReg = false;
        lucide.createIcons();

        // --- AUTH ---
        document.getElementById('toggleAuth').onclick = () => {
            isReg = !isReg;
            document.getElementById('reg-fields').style.display = isReg ? 'block' : 'none';
            document.getElementById('authBtn').innerText = isReg ? 'Создать аккаунт' : 'Войти';
        };

        document.getElementById('authBtn').onclick = async () => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            try {
                if(isReg) {
                    const n = document.getElementById('nick').value;
                    const res = await createUserWithEmailAndPassword(auth, e, p);
                    await updateProfile(res.user, { displayName: n, photoURL: `https://api.dicebear.com/7.x/avataaars/svg?seed=${n}` });
                } else { await signInWithEmailAndPassword(auth, e, p); }
            } catch (err) { alert("Ошибка! Проверьте данные"); }
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('pPic').src = user.photoURL;
                document.getElementById('pNick').innerText = user.displayName;
                document.getElementById('pEmail').innerText = user.email;
                initChat();
            } else { document.getElementById('auth-screen').style.display = 'flex'; }
        });

        // --- IMGBB UPLOAD ---
        async function upload(file) {
            const form = new FormData();
            form.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: form });
            const data = await res.json();
            return data.data.url;
        }

        document.getElementById('fileInp').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const url = await upload(file);
            await addDoc(collection(db, "messages"), { type: "img", url, user: auth.currentUser.displayName, ava: auth.currentUser.photoURL, uid: auth.currentUser.uid, time: serverTimestamp() });
        };

        document.getElementById('avaInp').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const url = await upload(file);
            await updateProfile(auth.currentUser, { photoURL: url });
            document.getElementById('pPic').src = url;
        };

        // --- CHAT LOGIC ---
        function initChat() {
            onSnapshot(query(collection(db, "messages"), orderBy("time", "asc")), (snaps) => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                snaps.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    const content = m.type === "img" ? `<img src="${m.url}" class="msg-img">` : m.text;
                    box.innerHTML += `
                        <div class="msg-row ${isMe ? 'me' : 'not-me'}">
                            <img src="${m.ava}" class="ava-msg">
                            <div class="bubble">
                                <div style="font-size:10px; opacity:0.6; margin-bottom:2px">${m.user}</div>
                                ${content}
                            </div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('msgInp').value;
            if(!val.trim()) return;
            await addDoc(collection(db, "messages"), { type: "text", text: val, user: auth.currentUser.displayName, ava: auth.currentUser.photoURL, uid: auth.currentUser.uid, time: serverTimestamp() });
            document.getElementById('msgInp').value = "";
        };

        // --- UI UI ---
        document.getElementById('openProf').onclick = () => document.getElementById('prof-modal').style.display = 'flex';
        window.closeProf = () => document.getElementById('prof-modal').style.display = 'none';
        document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
