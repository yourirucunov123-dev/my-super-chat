<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Directo Pro</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --p: #248bf5; --bg: #09090b; --c: #18181b; --b: #27272a; --t: #fafafa; --s: #a1a1aa; --danger: #ef4444; 
            /* Если кнопки всё еще мешают, увеличь этот отступ до 60px или 80px */
            --bottom-gap: 50px; 
        }
        [data-theme="light"] { --bg: #f4f4f5; --c: #ffffff; --b: #e4e4e7; --t: #09090b; --s: #71717a; }
        
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            background: #000; /* Фон за пределами приложения */
            overflow: hidden;
            position: fixed;
        }

        #app-wrapper { 
            display: flex; 
            flex-direction: column; 
            background: var(--bg);
            color: var(--t);
            width: 100%;
            /* Высота будет установлена через JavaScript */
            height: 100%; 
            /* Делаем отступ снизу, чтобы приложение буквально "висело" над кнопками */
            margin-bottom: var(--bottom-gap);
            position: relative;
        }

        .nav-bar { 
            background: var(--c); 
            border-top: 1px solid var(--b); 
            display: flex; 
            justify-content: space-around; 
            padding: 12px 0; 
            z-index: 1000; 
            flex-shrink: 0;
        }

        .nav-item { color: var(--s); cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 11px; gap: 4px; flex: 1; }
        .nav-item.active { color: var(--p); }

        .screen { flex: 1; display: none; flex-direction: column; overflow: hidden; padding-top: 20px; }
        .screen.active { display: flex; }

        .header { padding: 15px 20px; background: var(--c); border-bottom: 1px solid var(--b); font-weight: 700; font-size: 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        .card { background: var(--c); border: 1px solid var(--b); border-radius: 20px; padding: 15px; }
        .input-zone { padding: 10px 15px; background: var(--c); border-top: 1px solid var(--b); display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        .input-field { flex: 1; background: var(--bg); border: 1px solid var(--b); color: var(--t); padding: 10px 15px; border-radius: 20px; font-size: 15px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--p); border: none; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        .ava { width: 40px; height: 40px; border-radius: 12px; object-fit: cover; background: var(--b); }
        .bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 15px; margin-bottom: 5px; }
        .bubble.me { align-self: flex-end; background: var(--p); color: white; border-bottom-right-radius: 4px; }
        .bubble.not-me { align-self: flex-start; background: var(--b); border-bottom-left-radius: 4px; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

<div id="app-wrapper">
    <div id="auth-screen">
        <div class="card" style="width:100%; max-width:350px; text-align:center;">
            <h1 style="color:var(--p); font-size: 36px; margin: 0 0 20px 0;">Directo</h1>
            <input type="email" id="email" placeholder="Email" class="input-field" style="width:100%; margin-bottom:10px;">
            <input type="password" id="pass" placeholder="Пароль" class="input-field" style="width:100%; margin-bottom:10px;">
            <div id="reg-box" style="display:none">
                <input type="text" id="nick" placeholder="Никнейм" class="input-field" style="width:100%; margin-bottom:10px;">
            </div>
            <button class="btn-circle" id="authBtn" style="width:100%; border-radius:12px;">Войти</button>
            <p id="toggleAuth" style="font-size:14px; color:var(--p); cursor:pointer; margin-top:15px;">Создать аккаунт</p>
        </div>
    </div>

    <div id="scr-feed" class="screen active">
        <div class="header">Лента <i data-lucide="plus-circle" id="addPostBtn"></i></div>
        <div id="post-input" style="display:none; padding:15px; background:var(--c); border-bottom:1px solid var(--b);">
            <div style="display:flex; gap:10px;">
                <input type="text" id="postText" placeholder="Что нового?" class="input-field">
                <button class="btn-circle" id="sendPost"><i data-lucide="send"></i></button>
            </div>
        </div>
        <div class="content-scroll" id="feed-items"></div>
    </div>

    <div id="scr-chats" class="screen">
        <div class="header">Чаты</div>
        <div class="content-scroll" id="chat-list"></div>
    </div>

    <div id="scr-msg" class="screen">
        <div class="header">
            <i data-lucide="chevron-left" onclick="showScreen('chats')"></i>
            <span id="chat-title">Чат</span>
            <div style="width:24px"></div>
        </div>
        <div class="content-scroll" id="messages-box"></div>
        <div class="input-zone">
            <input type="text" id="msgInput" placeholder="Текст..." class="input-field">
            <button class="btn-circle" id="sendMsg"><i data-lucide="arrow-up"></i></button>
        </div>
    </div>

    <div id="scr-prof" class="screen">
        <div class="header">Настройки</div>
        <div class="content-scroll" style="align-items:center;">
            <img id="myPic" class="ava" style="width:80px; height:80px; margin-bottom:10px;">
            <h2 id="myNickDisplay">User</h2>
            <button class="card" onclick="logout()" style="width:100%">Выйти</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showScreen('feed', this)"><i data-lucide="home"></i>Лента</div>
        <div class="nav-item" onclick="showScreen('chats', this)"><i data-lucide="message-square"></i>Чаты</div>
        <div class="nav-item" onclick="showScreen('prof', this)"><i data-lucide="user"></i>Профиль</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- FIX FOR ANDROID NAVIGATION BAR ---
    function fixHeight() {
        // Устанавливаем высоту враппера ровно по размеру видимого окна за вычетом ГЭПА
        const gap = 50; // Тот же размер, что в --bottom-gap
        const vh = window.innerHeight;
        document.getElementById('app-wrapper').style.height = (vh - gap) + 'px';
    }
    window.addEventListener('resize', fixHeight);
    window.addEventListener('load', fixHeight);
    fixHeight();
    // ---------------------------------------

    const firebaseConfig = {
        apiKey: "AIzaSyDdOZrTcE4ATDlGldnW8_dWRmHuaUuJfak",
        authDomain: "mysuperchat-d1c29.firebaseapp.com",
        projectId: "mysuperchat-d1c29",
        storageBucket: "mysuperchat-d1c29.firebasestorage.app",
        messagingSenderId: "299888628640",
        appId: "1:299888628640:web:caf0535b94e389c7948ac5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let user = null;
    lucide.createIcons();

    window.showScreen = (id, el) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scr-' + id).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        lucide.createIcons();
    };

    onAuthStateChanged(auth, u => {
        if(u) {
            user = u;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('myPic').src = u.photoURL;
            document.getElementById('myNickDisplay').innerText = u.displayName;
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    document.getElementById('authBtn').onclick = async () => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        try {
            if(document.getElementById('reg-box').style.display === 'block') {
                const n = document.getElementById('nick').value;
                const res = await createUserWithEmailAndPassword(auth, e, p);
                const ava = `https://api.dicebear.com/7.x/identicon/svg?seed=${n}`;
                await updateProfile(res.user, { displayName: n, photoURL: ava });
                await setDoc(doc(db, "users", res.user.uid), { uid: res.user.uid, nick: n.toLowerCase(), avatar: ava });
            } else {
                await signInWithEmailAndPassword(auth, e, p);
            }
        } catch (err) { alert(err.message); }
    };

    document.getElementById('toggleAuth').onclick = () => {
        const b = document.getElementById('reg-box');
        b.style.display = b.style.display === 'none' ? 'block' : 'none';
    };

    window.logout = () => signOut(auth).then(() => location.reload());
</script>
</body>
</html>
