<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Directo | Private Messenger</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --p: #248bf5; --bg: #000000; --c: #1c1c1e; --b: #2c2c2e; --t: #ffffff; --s: #8e8e93;
        }
        [data-theme="light"] {
            --bg: #f2f2f7; --c: #ffffff; --b: #e5e5ea; --t: #000000; --s: #8e8e93;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; transition: background 0.2s, color 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--t); height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar */
        .side { width: 350px; background: var(--c); border-right: 1px solid var(--b); display: flex; flex-direction: column; z-index: 10; }
        .side-h { padding: 15px; border-bottom: 1px solid var(--b); }
        .logo { font-size: 22px; font-weight: 800; color: var(--p); letter-spacing: -1px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        .search-box { background: var(--bg); border-radius: 10px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--b); }
        .search-box input { background: none; border: none; color: var(--t); flex: 1; outline: none; }

        .items { flex: 1; overflow-y: auto; }
        .item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #ffffff05; position: relative; }
        .item:hover { background: rgba(142, 142, 147, 0.1); }
        .item.active { background: rgba(36, 139, 245, 0.15); }
        .ava { width: 45px; height: 45px; border-radius: 14px; object-fit: cover; background: var(--b); }

        /* Main Chat */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg); }
        .main-h { padding: 10px 20px; background: var(--c); border-bottom: 1px solid var(--b); display: flex; align-items: center; justify-content: space-between; }
        
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; }
        .msg.me { align-self: flex-end; background: var(--p); color: #fff; border-bottom-right-radius: 4px; }
        .msg.not-me { align-self: flex-start; background: var(--c); border: 1px solid var(--b); border-bottom-left-radius: 4px; }
        .msg img { width: 100%; border-radius: 10px; margin-top: 5px; }

        /* Input */
        .in-bar { padding: 15px 20px; background: var(--c); border-top: 1px solid var(--b); display: flex; align-items: center; gap: 12px; }
        .in-box { flex: 1; background: var(--bg); border-radius: 20px; padding: 8px 15px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--b); }
        .in-box input { flex: 1; background: none; border: none; color: var(--t); outline: none; padding: 5px 0; }

        /* Overlays */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .card { background: var(--c); padding: 30px; border-radius: 25px; width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--b); }
        
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-p { background: var(--p); color: #fff; }
        
        @media (max-width: 768px) {
            .side { width: 100%; position: absolute; inset: 0; }
            .side.hide { transform: translateX(-100%); }
            .main { width: 100%; }
        }
    </style>
</head>
<body data-theme="dark">

    <div id="auth-screen" class="overlay" style="display: flex; background: var(--bg); backdrop-filter: none;">
        <div class="card">
            <div class="logo">Directo</div>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:var(--bg); border:1px solid var(--b); color:var(--t);">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:var(--bg); border:1px solid var(--b); color:var(--t);">
            <div id="reg-info" style="display:none"><input type="text" id="nick" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:var(--bg); border:1px solid var(--b); color:var(--t);"></div>
            <button class="btn btn-p" id="authBtn">–í–æ–π—Ç–∏</button>
            <p onclick="toggleAuthMode()" id="toggleTxt" style="font-size:12px; color:var(--p); margin-top:15px; cursor:pointer;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>
    </div>

    <div class="side" id="sidebar">
        <div class="side-h">
            <div class="logo"><span>Directo</span> <div style="flex:1"></div> <button onclick="toggleTheme()" style="background:none; border:none; color:var(--s); cursor:pointer;"><i data-lucide="sun"></i></button></div>
            <div class="search-box">
                <i data-lucide="search" size="18" style="color:var(--s)"></i>
                <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...">
            </div>
        </div>
        <div class="items" id="chatList">
            </div>
        <div class="side-h" style="border-top: 1px solid var(--b); display:flex; align-items:center; gap:10px; cursor:pointer" onclick="showProf()">
            <img id="myAva" class="ava" style="width:35px; height:35px">
            <div style="font-size:14px; font-weight:600" id="myNick">...</div>
        </div>
    </div>

    <div class="main">
        <div class="main-h">
            <div style="display:flex; align-items:center; gap:12px">
                <button onclick="backToSidebar()" id="backBtn" style="background:none; border:none; color:var(--t); display:none"><i data-lucide="chevron-left"></i></button>
                <img id="chatAva" class="ava" style="width:38px; height:38px; display:none">
                <div>
                    <div id="chatName" style="font-weight:600">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                    <div id="chatStatus" style="font-size:11px; color:var(--p)"></div>
                </div>
            </div>
            <i data-lucide="more-vertical" style="color:var(--s)"></i>
        </div>

        <div id="msgs"></div>

        <div class="in-bar">
            <label style="cursor:pointer; color:var(--s)"><i data-lucide="paperclip"></i><input type="file" id="fileInp" hidden accept="image/*"></label>
            <div class="in-box">
                <input type="text" id="mInp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="addEmoji('üòä')" style="background:none; border:none; cursor:pointer">üòä</button>
            </div>
            <button class="btn-p" id="sendBtn" style="width:40px; height:40px; border-radius:50%; margin:0; display:flex; align-items:center; justify-content:center"><i data-lucide="arrow-up"></i></button>
        </div>
    </div>

    <div id="prof-overlay" class="overlay">
        <div class="card">
            <label style="cursor:pointer">
                <img id="pAva" class="ava" style="width:100px; height:100px; border-radius:30px; border:3px solid var(--p)">
                <input type="file" id="avaInp" hidden accept="image/*">
            </label>
            <h2 id="pNick" style="margin:10px 0">...</h2>
            <button class="btn" style="background:var(--b); color:var(--t)" onclick="hideProf()">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button class="btn" style="background:#ff3b30; color:#fff" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdOZrTcE4ATDlGldnW8_dWRmHuaUuJfak",
            authDomain: "mysuperchat-d1c29.firebaseapp.com",
            projectId: "mysuperchat-d1c29",
            storageBucket: "mysuperchat-d1c29.firebasestorage.app",
            messagingSenderId: "299888628640",
            appId: "1:299888628640:web:caf0535b94e389c7948ac5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const IMGBB_KEY = "699042c759021469e38f5370217a808f";

        let currentChatId = null;
        let isRegMode = false;
        lucide.createIcons();

        // –¢–ï–ú–ê
        window.toggleTheme = () => {
            const b = document.body;
            b.dataset.theme = b.dataset.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', b.dataset.theme);
        };
        if(localStorage.getItem('theme')) document.body.dataset.theme = localStorage.getItem('theme');

        // AUTH
        window.toggleAuthMode = () => {
            isRegMode = !isRegMode;
            document.getElementById('reg-info').style.display = isRegMode ? 'block' : 'none';
            document.getElementById('authBtn').innerText = isRegMode ? '–°–æ–∑–¥–∞—Ç—å' : '–í–æ–π—Ç–∏';
            document.getElementById('toggleTxt').innerText = isRegMode ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
        };

        document.getElementById('authBtn').onclick = async () => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            try {
                if(isRegMode) {
                    const n = document.getElementById('nick').value;
                    const res = await createUserWithEmailAndPassword(auth, e, p);
                    const ava = `https://api.dicebear.com/7.x/avataaars/svg?seed=${n}`;
                    await updateProfile(res.user, { displayName: n, photoURL: ava });
                    await setDoc(doc(db, "users", res.user.uid), { uid: res.user.uid, nick: n, email: e, avatar: ava });
                } else { await signInWithEmailAndPassword(auth, e, p); }
            } catch (err) { alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞"); }
        };

        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('myAva').src = user.photoURL;
                document.getElementById('myNick').innerText = user.displayName;
                loadChats();
            } else { document.getElementById('auth-screen').style.display = 'flex'; }
        });

        // –ü–û–ò–°–ö –ò –ß–ê–¢–´
        document.getElementById('userSearch').oninput = async (e) => {
            const val = e.target.value.trim();
            if(val.length < 2) return loadChats();
            const q = query(collection(db, "users"), where("nick", ">=", val), where("nick", "<=", val + '\uf8ff'), limit(10));
            const snap = await getDoc(q); // Simplified for example
            const list = document.getElementById('chatList');
            list.innerHTML = `<div style="padding:10px; font-size:12px; color:var(--s)">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</div>`;
            onSnapshot(q, (snaps) => {
                snaps.forEach(uDoc => {
                    const u = uDoc.data();
                    if(u.uid === auth.currentUser.uid) return;
                    list.innerHTML += `<div class="item" onclick="startPrivateChat('${u.uid}', '${u.nick}', '${u.avatar}')">
                        <img src="${u.avatar}" class="ava">
                        <div><b>${u.nick}</b><br><span style="font-size:11px; color:var(--p)">–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</span></div>
                    </div>`;
                });
            });
        };

        window.startPrivateChat = (uid, nick, ava) => {
            currentChatId = auth.currentUser.uid < uid ? auth.currentUser.uid + uid : uid + auth.currentUser.uid;
            document.getElementById('chatName').innerText = nick;
            document.getElementById('chatAva').src = ava;
            document.getElementById('chatAva').style.display = 'block';
            document.getElementById('chatStatus').innerText = '–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hide');
                document.getElementById('backBtn').style.display = 'block';
            }
            loadMessages();
        };

        function loadMessages() {
            const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("time", "asc"));
            onSnapshot(q, (snaps) => {
                const box = document.getElementById('msgs');
                box.innerHTML = "";
                snaps.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    const content = m.type === 'img' ? `<img src="${m.url}">` : m.text;
                    box.innerHTML += `<div class="msg ${isMe ? 'me' : 'not-me'}">${content}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const t = document.getElementById('mInp').value;
            if(!t.trim() || !currentChatId) return;
            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                type: 'text', text: t, uid: auth.currentUser.uid, time: serverTimestamp()
            });
            document.getElementById('mInp').value = "";
        };

        // –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û (IMGBB)
        async function upload(file) {
            const f = new FormData(); f.append("image", file);
            const r = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: f });
            const d = await r.json(); return d.data.url;
        }

        document.getElementById('fileInp').onchange = async e => {
            const url = await upload(e.target.files[0]);
            await addDoc(collection(db, "chats", currentChatId, "messages"), { type: 'img', url, uid: auth.currentUser.uid, time: serverTimestamp() });
        };

        // PROFILE
        window.showProf = () => {
            document.getElementById('pAva').src = auth.currentUser.photoURL;
            document.getElementById('pNick').innerText = auth.currentUser.displayName;
            document.getElementById('prof-overlay').style.display = 'flex';
        };
        window.hideProf = () => document.getElementById('prof-overlay').style.display = 'none';
        window.logout = () => signOut(auth).then(() => location.reload());
        window.addEmoji = (e) => document.getElementById('mInp').value += e;
        window.backToSidebar = () => {
            document.getElementById('sidebar').classList.remove('hide');
            document.getElementById('backBtn').style.display = 'none';
        }

        function loadChats() {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
            document.getElementById('chatList').innerHTML = `<div style="padding:20px; text-align:center; color:var(--s); font-size:13px">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</div>`;
        }
    </script>
</body>
</html>
