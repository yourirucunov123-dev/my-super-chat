<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirTalk Messenger</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --accent: #00ffa3; --bg: #09090b; --card: #18181b; --border: #27272a; --text: #fafafa; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Auth */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--card); padding: 40px; border-radius: 28px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--border); }
        
        /* UI */
        header { padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg-wrapper { display: flex; gap: 10px; max-width: 85%; align-items: flex-end; }
        .msg-wrapper.me { flex-direction: row-reverse; align-self: flex-end; }
        .mini-ava { width: 32px; height: 32px; border-radius: 10px; object-fit: cover; background: #333; }
        
        .msg-content { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; }
        .me .msg-content { background: var(--accent); color: #000; border-bottom-right-radius: 2px; }
        .not-me .msg-content { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 2px; }

        /* Фото в чате */
        .chat-img { width: 100%; max-width: 250px; border-radius: 12px; margin-top: 5px; display: block; cursor: pointer; }

        /* Ввод */
        .input-bar { padding: 15px; background: var(--card); display: flex; gap: 10px; align-items: center; border-top: 1px solid var(--border); }
        .input-bar input { flex: 1; background: #000; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 12px; }
        .icon-btn { background: none; border: none; color: #a1a1aa; cursor: pointer; display: flex; align-items: center; }
        .send-btn { background: var(--accent); color: #000; width: 45px; height: 45px; border-radius: 12px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        #loading-bar { position: fixed; top: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: 0.3s; z-index: 100; }
    </style>
</head>
<body>

    <div id="loading-bar"></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color:var(--accent)">AirTalk</h1>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:#000; border:1px solid #333; color:#fff">
            <input type="password" id="pass" placeholder="Пароль" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:#000; border:1px solid #333; color:#fff">
            <div id="reg-box" style="display:none">
                <input type="text" id="nick" placeholder="Ваше имя" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:#000; border:1px solid #333; color:#fff">
            </div>
            <button class="send-btn" id="authBtn" style="width:100%; font-weight:bold">Войти</button>
            <p id="toggle" style="margin-top:15px; font-size:12px; color:var(--accent); cursor:pointer">Создать аккаунт</p>
        </div>
    </div>

    <header>
        <div style="font-weight:bold; color:var(--accent)">AIRTALK Messenger</div>
        <img id="myAva" src="" style="width:35px; height:35px; border-radius:10px; background:#333; cursor:pointer" onclick="logout()">
    </header>

    <div id="chat-messages"></div>

    <div class="input-bar">
        <label class="icon-btn">
            <i data-lucide="paperclip"></i>
            <input type="file" id="imgSend" hidden accept="image/*">
        </label>
        <input type="text" id="mInput" placeholder="Сообщение...">
        <button class="send-btn" id="sendBtn"><i data-lucide="send"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdOZrTcE4ATDlGldnW8_dWRmHuaUuJfak",
            authDomain: "mysuperchat-d1c29.firebaseapp.com",
            projectId: "mysuperchat-d1c29",
            storageBucket: "mysuperchat-d1c29.firebasestorage.app",
            messagingSenderId: "299888628640",
            appId: "1:299888628640:web:caf0535b94e389c7948ac5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const IMGBB_KEY = "699042c759021469e38f5370217a808f";

        let isReg = false;
        lucide.createIcons();

        // АВТОРИЗАЦИЯ
        document.getElementById('toggle').onclick = () => {
            isReg = !isReg;
            document.getElementById('reg-box').style.display = isReg ? 'block' : 'none';
            document.getElementById('authBtn').innerText = isReg ? 'Создать' : 'Войти';
        };

        document.getElementById('authBtn').onclick = async () => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            try {
                if(isReg) {
                    const n = document.getElementById('nick').value;
                    const res = await createUserWithEmailAndPassword(auth, e, p);
                    await updateProfile(res.user, { displayName: n, photoURL: `https://api.dicebear.com/7.x/identicon/svg?seed=${n}` });
                } else { await signInWithEmailAndPassword(auth, e, p); }
                location.reload();
            } catch (err) { alert(err.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('myAva').src = user.photoURL;
                initChat();
            } else { document.getElementById('auth-screen').style.display = 'flex'; }
        });

        // ЗАГРУЗКА НА IMGBB (POST REQUEST)
        async function uploadImage(file) {
            document.getElementById('loading-bar').style.width = '50%';
            const formData = new FormData();
            formData.append("image", file);
            
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            document.getElementById('loading-bar').style.width = '100%';
            setTimeout(() => document.getElementById('loading-bar').style.width = '0%', 500);
            return data.data.url;
        }

        // ОТПРАВКА ФОТО В ЧАТ
        document.getElementById('imgSend').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const url = await uploadImage(file);
            await addDoc(collection(db, "messages"), {
                type: "image",
                url: url,
                user: auth.currentUser.displayName,
                avatar: auth.currentUser.photoURL,
                uid: auth.currentUser.uid,
                time: serverTimestamp()
            });
        };

        // ЧАТ
        function initChat() {
            onSnapshot(query(collection(db, "messages"), orderBy("time", "asc")), (snaps) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = "";
                snaps.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    const content = m.type === "image" 
                        ? `<img src="${m.url}" class="chat-img">` 
                        : `<div>${m.text}</div>`;

                    box.innerHTML += `
                        <div class="msg-wrapper ${isMe ? 'me' : 'not-me'}">
                            <img src="${m.avatar}" class="mini-ava">
                            <div class="msg-content">
                                <div style="font-size:9px; opacity:0.5; margin-bottom:4px">${m.user}</div>
                                ${content}
                            </div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('mInput').value;
            if(!val.trim()) return;
            await addDoc(collection(db, "messages"), {
                type: "text", text: val, user: auth.currentUser.displayName, 
                avatar: auth.currentUser.photoURL, uid: auth.currentUser.uid, time: serverTimestamp()
            });
            document.getElementById('mInput').value = "";
        };

        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
