<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirUSB Connect</title>
    <style>
        :root { --primary: #00ff88; --bg: #0d1117; --panel: #161b22; --border: #30363d; --text: #c9d1d9; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Авторизация */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--panel); padding: 30px; border-radius: 12px; width: 100%; max-width: 320px; border: 1px solid var(--border); text-align: center; }
        
        /* Навигация и Шапка */
        header { background: var(--panel); padding: 15px; border-bottom: 1px solid var(--border); text-align: center; font-weight: bold; color: var(--primary); }
        nav { background: var(--panel); display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid var(--border); }
        nav button { background: none; border: none; color: #8b949e; cursor: pointer; font-size: 12px; }
        nav button.active { color: var(--primary); font-weight: bold; }

        /* Контент */
        .page { flex: 1; display: none; flex-direction: column; overflow-y: auto; }
        .page.active { display: flex; }

        /* Лента и Чат */
        .item { background: var(--panel); margin: 10px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #30363d; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; position: relative; }
        .msg.me { align-self: flex-end; background: #238636; color: white; }
        .msg.not-me { align-self: flex-start; background: #30363d; }
        .msg-time { font-size: 9px; opacity: 0.7; margin-top: 4px; display: block; text-align: right; }

        /* Ввод */
        .input-group { padding: 15px; background: var(--bg); border-top: 1px solid var(--border); display: flex; gap: 8px; }
        input { background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        .btn { background: var(--primary); border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-sec { background: none; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color:var(--primary)">AirUSB</h2>
            <input type="email" id="authEmail" placeholder="Email">
            <input type="password" id="authPass" placeholder="Пароль">
            <div id="reg-box" style="display:none">
                <input type="text" id="authNick" placeholder="Твой ник">
            </div>
            <button class="btn" id="authActionBtn">Войти</button>
            <button class="btn btn-sec" id="toggleMode">Создать аккаунт</button>
        </div>
    </div>

    <header id="h-title">Чат</header>

    <div id="page-chat" class="page active">
        <div id="chat-box"></div>
        <div class="input-group">
            <input type="text" id="msgInput" placeholder="Написать...">
            <button id="sendBtn" style="width:50px; background:var(--primary); border-radius:6px; border:none">➤</button>
        </div>
    </div>

    <div id="page-feed" class="page">
        <div style="padding:15px; border-bottom:1px solid var(--border)">
            <input type="text" id="feedInput" placeholder="Что нового?">
            <button id="postBtn" class="btn" style="margin-top:8px">Опубликовать</button>
        </div>
        <div id="feed-items"></div>
    </div>

    <div id="page-prof" class="page" style="padding:20px; text-align:center">
        <img id="myBigAvatar" src="" class="avatar" style="width:80px; height:80px; margin-bottom:10px">
        <h3 id="myNickDisplay">...</h3>
        <p id="myEmailDisplay" style="font-size:12px; opacity:0.6"></p>
        
        <div style="margin:20px 0; padding:15px; background:var(--panel); border-radius:8px; border:1px solid var(--border)">
            <label style="font-size:10px; color:var(--primary); display:block; margin-bottom:5px">НОМЕР ТЕЛЕФОНА</label>
            <div id="phoneStatus">Не привязан</div>
            <div id="phoneForm" style="margin-top:10px">
                <input type="tel" id="newPhone" placeholder="+7 000 000 0000" style="text-align:center">
                <button class="btn" onclick="updatePhone()" style="margin-top:5px">Сохранить</button>
            </div>
        </div>
        
        <button class="btn" onclick="signOutUser()" style="background:#f85149; color:white">Выйти</button>
    </div>

    <nav>
        <button onclick="changePage('chat', this)" class="active">ЧАТ</button>
        <button onclick="changePage('feed', this)">ЛЕНТА</button>
        <button onclick="changePage('prof', this)">ПРОФИЛЬ</button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdOZrTcE4ATDlGldnW8_dWRmHuaUuJfak",
            authDomain: "mysuperchat-d1c29.firebaseapp.com",
            projectId: "mysuperchat-d1c29",
            storageBucket: "mysuperchat-d1c29.firebasestorage.app",
            messagingSenderId: "299888628640",
            appId: "1:299888628640:web:caf0535b94e389c7948ac5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isReg = false;
        let myData = null;

        // Переключение режимов входа
        document.getElementById('toggleMode').onclick = () => {
            isReg = !isReg;
            document.getElementById('reg-box').style.display = isReg ? 'block' : 'none';
            document.getElementById('authActionBtn').innerText = isReg ? 'Создать' : 'Войти';
            document.getElementById('toggleMode').innerText = isReg ? 'Уже есть аккаунт?' : 'Создать аккаунт';
        };

        // Вход и Регистрация
        document.getElementById('authActionBtn').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            try {
                if(isReg) {
                    const nick = document.getElementById('authNick').value;
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    const ava = `https://api.dicebear.com/7.x/pixel-art/svg?seed=${nick}`;
                    await updateProfile(res.user, { displayName: nick, photoURL: ava });
                    await setDoc(doc(db, "users", res.user.uid), { nick, email, avatar: ava, phone: "" });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) { alert(e.message); }
        };

        window.signOutUser = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.getElementById('auth-screen').style.display = 'none';
                const userSnap = await getDoc(doc(db, "users", user.uid));
                myData = userSnap.data();
                setupUI(user);
                startListening();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });

        function setupUI(user) {
            document.getElementById('myBigAvatar').src = user.photoURL;
            document.getElementById('myNickDisplay').innerText = user.displayName;
            document.getElementById('myEmailDisplay').innerText = user.email;
            if(myData.phone) {
                document.getElementById('phoneStatus').innerText = myData.phone;
                document.getElementById('phoneForm').style.display = 'none';
            }
        }

        window.updatePhone = async () => {
            const p = document.getElementById('newPhone').value;
            if(p) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { phone: p });
                location.reload();
            }
        };

        window.changePage = (id, btn) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('h-title').innerText = btn.innerText;
        };

        // Чат и Лента в реальном времени
        function startListening() {
            // Чат
            onSnapshot(query(collection(db, "messages"), orderBy("time", "asc")), (snaps) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = "";
                snaps.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    const t = m.time ? new Date(m.time.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                    box.innerHTML += `
                        <div class="msg ${isMe ? 'me' : 'not-me'}">
                            <div class="user-info" style="font-size:10px; margin:0">
                                <b>${m.user}</b>
                            </div>
                            ${m.text}
                            <span class="msg-time">${t}</span>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });

            // Лента
            onSnapshot(query(collection(db, "posts"), orderBy("time", "desc")), (snaps) => {
                const box = document.getElementById('feed-items');
                box.innerHTML = "";
                snaps.forEach(d => {
                    const p = d.data();
                    box.innerHTML += `
                        <div class="item">
                            <div class="user-info">
                                <img src="${p.avatar}" class="avatar">
                                <b>${p.user}</b>
                            </div>
                            <div>${p.text}</div>
                        </div>`;
                });
            });
        }

        // Отправка
        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('msgInput').value;
            if(!val.trim()) return;
            await addDoc(collection(db, "messages"), {
                text: val, user: auth.currentUser.displayName, uid: auth.currentUser.uid, time: serverTimestamp()
            });
            document.getElementById('msgInput').value = "";
        };

        document.getElementById('postBtn').onclick = async () => {
            const val = document.getElementById('feedInput').value;
            if(!val.trim()) return;
            await addDoc(collection(db, "posts"), {
                text: val, user: auth.currentUser.displayName, avatar: auth.currentUser.photoURL, time: serverTimestamp()
            });
            document.getElementById('feedInput').value = "";
        };
    </script>
</body>
</html>
